
{% extends 'admin/base.html' %}

{% block title %}Admin Roles Management{% endblock %}

{% block page_title %}
     Admin Roles Management
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Roles</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-4">
        <!-- Create New Role Form - Mobile First Design -->
        <div class="col-12 col-xl-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-user-plus me-2 text-primary"></i>Create New Role
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="createRoleForm" novalidate>
                       <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/> 
                        
                        <!-- Name Field -->
                        <div class="mb-3">
                            <label for="Name" class="form-label">
                                <i class="fas fa-user me-2 text-primary"></i>Name
                            </label>
                            <input type="text" class="form-control" id="Name" name="NAME" required 
                                placeholder="Enter Name" aria-describedby="nameHelp">
                            <div id="nameHelp" class="form-text">Enter the full name of the admin user</div>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="mb-3">
                            <label for="email_id" class="form-label">
                                <i class="fas fa-envelope me-2 text-primary"></i>Email ID
                            </label>
                            <input type="email" class="form-control" id="email_id" name="email_id" required 
                                placeholder="Enter Email ID" aria-describedby="emailHelp">
                            <div id="emailHelp" class="form-text">This email will be used for login and notifications</div>
                        </div>
                        
                        <!-- Role Title Field -->
                        <div class="mb-3">
                            <label for="role" class="form-label">
                                <i class="fas fa-user-tag me-2 text-primary"></i>Role Title
                            </label>
                            <input type="text" class="form-control" id="role" name="role" required 
                                placeholder="Define Role" aria-describedby="roleHelp">
                            <div id="roleHelp" class="form-text">Example: Support Manager, Content Editor, System Admin</div>
                        </div>
                        
                        <!-- Phone Number Field -->
                        <div class="mb-3">
                            <label for="phone_number" class="form-label">
                                <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">+91</span>
                                <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                    placeholder="Enter Phone Number" maxlength="10"
                                    aria-describedby="phoneHelp">
                            </div>
                            <div id="phoneHelp" class="form-text">10-digit mobile number (optional)</div>
                        </div>
                        
                        <!-- Password Field -->
                        <div class="mb-4">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2 text-primary"></i>Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required
                                    placeholder="Enter Password" aria-describedby="passwordHelp">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword" 
                                    aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="passwordHelp" class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Password must be at least 8 characters
                            </div>
                        </div>
                        
                        <!-- Access Permissions -->
                        <div class="mb-4">
                            <label class="form-label d-block">
                                <i class="fas fa-shield-alt me-2 text-primary"></i>Access Permissions
                                <button type="button" id="selectAllPermissions" class="btn btn-sm btn-outline-secondary ms-2">
                                    Select All
                                </button>
                            </label>
                            <div class="row g-3 mt-1">
                                <div class="col-12 col-md-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">Core Functions</h6>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="dashboard" name="permissions[]" value="dashboard">
                                                <label class="form-check-label" for="dashboard">
                                                    <i class="fas fa-tachometer-alt me-1 text-secondary"></i> Dashboard
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="subscription_management" name="permissions[]" value="subscription_management">
                                                <label class="form-check-label" for="subscription_management">
                                                    <i class="fas fa-tags me-1 text-secondary"></i> Subscription Plans
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="subscribed_users_view" name="permissions[]" value="subscribed_users_view">
                                                <label class="form-check-label" for="subscribed_users_view">
                                                    <i class="fas fa-users me-1 text-secondary"></i> Subscribed Users
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="search_history" name="permissions[]" value="search_history">
                                                <label class="form-check-label" for="search_history">
                                                    <i class="fas fa-search me-1 text-secondary"></i> Search History
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">Administrative</h6>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="user_management" name="permissions[]" value="user_management">
                                                <label class="form-check-label" for="user_management">
                                                    <i class="fas fa-user-cog me-1 text-secondary"></i> User Management
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="payments" name="permissions[]" value="payments">
                                                <label class="form-check-label" for="payments">
                                                    <i class="fas fa-rupee-sign me-1 text-secondary"></i> Payments
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="manage_roles" name="permissions[]" value="manage_roles">
                                                <label class="form-check-label" for="manage_roles">
                                                    <i class="fas fa-user-shield me-1 text-secondary"></i> Role Management
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="contact_submissions" name="permissions[]" value="contact_submissions">
                                                <label class="form-check-label" for="contact_submissions">
                                                    <i class="fas fa-envelope me-1 text-secondary"></i> Contact Submissions
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="website_settings" name="permissions[]" value="website_settings">
                                                <label class="form-check-label" for="website_settings">
                                                    <i class="fas fa-cog me-2 text-secondary"></i>Website Settings
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" id="submitButton">
                            <i class="fas fa-save me-2"></i> Create Role
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Existing Roles - Mobile Optimized -->
        <div class="col-12 col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center py-3 gap-2">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog me-2 text-primary"></i>Existing Roles
                    </h5>
                    <div class="w-90 w-sm-auto">
                        <input type="text" id="roleSearch" class="form-control form-control-sm" 
                               placeholder="Search roles..." aria-label="Search roles">
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Mobile Cards View (visible on small screens) -->
                    <div class="d-block d-lg-none">
                        {% for role in roles %}
                        <div class="border-bottom p-3 role-card-mobile" data-role-name="{{ role.NAME|lower }}" data-role-email="{{ role.email_id|lower }}" data-role-title="{{ role.role|lower }}">
                            <div class="d-flex align-items-start justify-content-between">
                                <div class="d-flex align-items-start">
                                    <div class="avatar-circle bg-primary-subtle text-primary me-3 flex-shrink-0" style="width: 48px; height: 48px; line-height: 48px; font-size: 18px; text-align: center; border-radius: 50%;">
                                        {{ role.NAME[:1]|upper }}
                                    </div>
                                    <div class="flex-grow-1 min-w-0">
                                        <h6 class="fw-bold mb-1 text-truncate">{{ role.NAME }}</h6>
                                        <p class="text-muted mb-1 small text-truncate">{{ role.email_id }}</p>
                                        <span class="badge bg-primary">{{ role.role }}</span>
                                        {% if role.phone_number %}
                                            <div class="text-muted small mt-1">
                                                <i class="fas fa-phone me-1"></i>{{ role.phone_number }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('edit_role', role_id=role.id) }}">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a>
                                        </li>
                                        <li>
                                            <button type="button" class="dropdown-item view-role-details" data-role-id="{{ role.id }}">
                                                <i class="fas fa-eye me-2"></i>View Details
                                            </button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button type="button" class="dropdown-item text-danger delete-role-btn" 
                                                    data-role-id="{{ role.id }}" 
                                                    data-role-name="{{ role.NAME }}"
                                                    data-role-email="{{ role.email_id }}">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <!-- Permissions Preview for Mobile -->
                            <div class="mt-2">
                                <small class="text-muted">Permissions:</small>
                                <div class="mt-1">
                                    {% for perm in role.permission[:3] %}
                                        <span class="badge bg-light text-dark border me-1 mb-1">{{ perm }}</span>
                                    {% endfor %}
                                    {% if role.permission|length > 3 %}
                                        <span class="badge bg-secondary">+{{ role.permission|length - 3 }} more</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <div class="empty-state">
                                <div class="icon-wrapper bg-light rounded-circle p-4 mx-auto mb-3" style="width: fit-content;">
                                    <i class="fas fa-user-slash fs-1 text-muted"></i>
                                </div>
                                <h5>No roles have been created yet</h5>
                                <p class="text-muted mb-3">Create your first admin role using the form</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Desktop Table View (hidden on small screens) -->
                    <div class="d-none d-lg-block">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto; overflow-x: auto;">
                            <table class="table table-hover align-middle mb-0" id="rolesTable" style="min-width: max-content;">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th scope="col">Name</th>
                                        <th scope="col">Email ID</th>
                                        <th scope="col">Role</th>
                                        <th scope="col">Permissions</th>
                                        <th scope="col">Phone</th>
                                        <th scope="col" class="text-end sticky-top bg-light">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for role in roles %}
                                        <tr class="role-row-desktop" data-role-name="{{ role.NAME|lower }}" data-role-email="{{ role.email_id|lower }}" data-role-title="{{ role.role|lower }}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-circle bg-primary-subtle text-primary me-2">
                                                        {{ role.NAME[:1]|upper }}
                                                    </div>
                                                    <span class="fw-medium">{{ role.NAME }}</span>
                                                </div>
                                            </td>
                                            <td>{{ role.email_id }}</td>
                                            <td>
                                                <span class="badge bg-primary">{{ role.role }}</span>
                                            </td>
                                            <td>
                                                <div class="permission-chips" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    {% for perm in role.permission %}
                                                        <span class="badge bg-light text-dark border me-1 mb-1">{{ perm }}</span>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if role.phone_number %}
                                                    {{ role.phone_number }}
                                                {% else %}
                                                    <span class="text-muted">Not provided</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end position-sticky" style="right: 0; background-color: white; box-shadow: -2px 0 5px rgba(0,0,0,0.05);">
                                                <div class="btn-group">
                                                    <a href="{{ url_for('edit_role', role_id=role.id) }}" class="btn btn-sm btn-outline-primary" aria-label="Edit role">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-info view-role-details" data-role-id="{{ role.id }}" aria-label="View role details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-role-btn" 
                                                            data-role-id="{{ role.id }}" 
                                                            data-role-name="{{ role.NAME }}"
                                                            data-role-email="{{ role.email_id }}"
                                                            aria-label="Delete role">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center py-5">
                                                <div class="empty-state">
                                                    <div class="icon-wrapper bg-light rounded-circle p-4 mx-auto mb-3" style="width: fit-content;">
                                                        <i class="fas fa-user-slash fs-1 text-muted"></i>
                                                    </div>
                                                    <h5>No roles have been created yet</h5>
                                                    <p class="text-muted mb-3">Create your first admin role using the form</p>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Details Modal -->
<div class="modal fade" id="roleDetailsModal" tabindex="-1" aria-labelledby="roleDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="roleDetailsModalLabel">Role Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="role-details-content">
                    <!-- Will be filled dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary edit-role-link">Edit Role</a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteRoleModal" tabindex="-1" aria-labelledby="deleteRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteRoleModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="icon-wrapper bg-danger-subtle rounded-circle p-3 mx-auto mb-3" style="width: fit-content;">
                        <i class="fas fa-user-times fs-1 text-danger"></i>
                    </div>
                    <h6>Are you sure you want to delete this role?</h6>
                    <p class="text-muted mb-0">This action cannot be undone.</p>
                </div>
                
                <div class="alert alert-warning">
                    <strong>Role Details:</strong><br>
                    <span id="deleteRoleName"></span><br>
                    <span id="deleteRoleEmail"></span>
                </div>
                
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Warning:</strong> This will permanently remove the admin role and all associated permissions.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <form id="deleteRoleForm" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Role
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add animation to cards
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100 + (index * 100));
        });

        // Password visibility toggle
        const togglePassword = document.getElementById('togglePassword');
        const password = document.getElementById('password');
        
        if (togglePassword && password) {
            togglePassword.addEventListener('click', function() {
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                
                // Toggle icon
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }

        // Select all checkboxes functionality
        const selectAllBtn = document.getElementById('selectAllPermissions');
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('input[name="permissions[]"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                
                this.textContent = allChecked ? 'Select All' : 'Deselect All';
            });
        }
        
        // Enhanced search functionality for both mobile and desktop
        const roleSearch = document.getElementById('roleSearch');
        
        if (roleSearch) {
            roleSearch.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();
                
                // Search in mobile cards
                const mobileCards = document.querySelectorAll('.role-card-mobile');
                mobileCards.forEach(card => {
                    const name = card.getAttribute('data-role-name');
                    const email = card.getAttribute('data-role-email');
                    const role = card.getAttribute('data-role-title');
                    
                    if (name.includes(searchTerm) || email.includes(searchTerm) || role.includes(searchTerm)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // Search in desktop table
                const desktopRows = document.querySelectorAll('.role-row-desktop');
                desktopRows.forEach(row => {
                    const name = row.getAttribute('data-role-name');
                    const email = row.getAttribute('data-role-email');
                    const role = row.getAttribute('data-role-title');
                    
                    if (name.includes(searchTerm) || email.includes(searchTerm) || role.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
        
        // Role details modal functionality
        const viewButtons = document.querySelectorAll('.view-role-details');
        const roleDetailsModal = new bootstrap.Modal(document.getElementById('roleDetailsModal'), {});
        const roleDetailsContent = document.querySelector('.role-details-content');
        const editRoleLink = document.querySelector('.edit-role-link');
        
        if (viewButtons.length > 0 && roleDetailsContent) {
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const roleId = this.getAttribute('data-role-id');
                    
                    // Find the role data (works for both mobile and desktop)
                    let roleData = {};
                    
                    // Try to get from desktop table first
                    const row = document.querySelector(`.role-row-desktop button[data-role-id="${roleId}"]`)?.closest('tr');
                    if (row) {
                        const cells = row.querySelectorAll('td');
                        roleData.name = cells[0].textContent.trim();
                        roleData.email = cells[1].textContent.trim();
                        roleData.role = cells[2].textContent.trim();
                        
                        const permissionChips = row.querySelector('.permission-chips');
                        const permissionBadges = permissionChips ? permissionChips.querySelectorAll('.badge') : [];
                        roleData.permissions = Array.from(permissionBadges).map(badge => badge.textContent.trim());
                    } else {
                        // Try to get from mobile card
                        const card = document.querySelector(`.role-card-mobile button[data-role-id="${roleId}"]`)?.closest('.role-card-mobile');
                        if (card) {
                            roleData.name = card.querySelector('h6').textContent.trim();
                            roleData.email = card.querySelector('.text-muted').textContent.trim();
                            roleData.role = card.querySelector('.badge').textContent.trim();
                            
                            const permissionBadges = card.querySelectorAll('.badge:not(.bg-primary):not(.bg-secondary)');
                            roleData.permissions = Array.from(permissionBadges).map(badge => badge.textContent.trim());
                        }
                    }
                    
                    // Create permissions HTML
                    let permissionsHTML = '<div class="permission-chips-container d-flex flex-wrap mt-2">';
                    roleData.permissions.forEach(perm => {
                        permissionsHTML += `<span class="badge bg-light text-dark border me-1 mb-1">${perm}</span>`;
                    });
                    permissionsHTML += '</div>';
                    
                    // Update modal content
                    roleDetailsContent.innerHTML = `
                        <div class="text-center mb-4">
                            <div class="avatar-circle bg-primary text-white mx-auto mb-3" style="width: 70px; height: 70px; line-height: 70px; font-size: 2rem;">
                                ${roleData.name.charAt(0).toUpperCase()}
                            </div>
                            <h4>${roleData.name}</h4>
                            <span class="badge bg-primary">${roleData.role}</span>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold text-muted">Email:</label>
                            <div>${roleData.email}</div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold text-muted">Permissions:</label>
                            ${permissionsHTML}
                        </div>
                    `;
                    
                    // Update edit link
                    if (editRoleLink) {
                        editRoleLink.href = `/admin/roles/edit/${roleId}`;
                    }
                    
                    // Show modal
                    roleDetailsModal.show();
                });
            });
        }
        
        // Delete role functionality
        const deleteButtons = document.querySelectorAll('.delete-role-btn');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteRoleModal'), {});
        const deleteForm = document.getElementById('deleteRoleForm');
        const deleteRoleName = document.getElementById('deleteRoleName');
        const deleteRoleEmail = document.getElementById('deleteRoleEmail');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const roleId = this.getAttribute('data-role-id');
                const roleName = this.getAttribute('data-role-name');
                const roleEmail = this.getAttribute('data-role-email');
                
                // Update modal content
                deleteRoleName.textContent = `Name: ${roleName}`;
                deleteRoleEmail.textContent = `Email: ${roleEmail}`;
                
                // Update form action
                deleteForm.action = `/admin/roles/delete/${roleId}`;
                
                // Show modal
                deleteModal.show();
            });
        });
        
        // ROBUST FORM VALIDATION WITH PROPER BUTTON STATE MANAGEMENT
        const createRoleForm = document.getElementById('createRoleForm');
        if (createRoleForm) {
            const submitButton = createRoleForm.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton ? submitButton.innerHTML : '<i class="fas fa-save me-2"></i> Create Role';
            
            // Function to show validation message with better UX
            const showValidationError = (message, focusElement = null) => {
                // Remove existing alerts
                const existingAlert = createRoleForm.querySelector('.validation-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Create new alert
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show validation-alert';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insert at the top of the form
                createRoleForm.insertBefore(alertDiv, createRoleForm.firstChild);
                
                // Scroll to the top of the form to show the alert
                alertDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                // Focus on problematic element if provided
                if (focusElement) {
                    setTimeout(() => focusElement.focus(), 500);
                }
                
                // Auto-remove after 8 seconds
                setTimeout(() => {
                    if (alertDiv && alertDiv.parentElement) {
                        const bsAlert = new bootstrap.Alert(alertDiv);
                        bsAlert.close();
                    }
                }, 8000);
            };
            
            // Function to reset button state - IMPROVED
            const resetButton = () => {
                if (submitButton) {
                    submitButton.innerHTML = originalButtonHTML;
                    submitButton.disabled = false;
                    submitButton.classList.remove('disabled', 'btn-loading');
                    submitButton.style.pointerEvents = 'auto';
                    submitButton.style.opacity = '1';
                    
                    // Force button to be clickable
                    submitButton.removeAttribute('disabled');
                    
                    console.log('Button reset to:', submitButton.innerHTML);
                }
            };
            
            // Function to validate form with step-by-step specific messages
            const validateForm = () => {
                // Clear any existing validation alerts
                const existingAlert = createRoleForm.querySelector('.validation-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Remove any existing field validation states
                const invalidFields = createRoleForm.querySelectorAll('.is-invalid');
                invalidFields.forEach(field => field.classList.remove('is-invalid'));
                
                // 1. Check Name field first
                const nameInput = document.getElementById('Name');
                if (!nameInput || nameInput.value.trim().length === 0) {
                    nameInput?.classList.add('is-invalid');
                    showValidationError('Required name field', nameInput);
                    return false;
                }
                if (nameInput.value.trim().length < 2) {
                    nameInput.classList.add('is-invalid');
                    showValidationError('Name must be at least 2 characters long', nameInput);
                    return false;
                }
                
                // 2. Check Email field
                const emailInput = document.getElementById('email_id');
                if (!emailInput || emailInput.value.trim().length === 0) {
                    emailInput?.classList.add('is-invalid');
                    showValidationError('Required email id', emailInput);
                    return false;
                }
                if (!emailInput.checkValidity() || !isValidEmail(emailInput.value)) {
                    emailInput.classList.add('is-invalid');
                    showValidationError('Please enter a valid email address', emailInput);
                    return false;
                }
                
                // 3. Check Role Title field
                const roleInput = document.getElementById('role');
                if (!roleInput || roleInput.value.trim().length === 0) {
                    roleInput?.classList.add('is-invalid');
                    showValidationError('Required role title', roleInput);
                    return false;
                }
                if (roleInput.value.trim().length < 2) {
                    roleInput.classList.add('is-invalid');
                    showValidationError('Role title must be at least 2 characters long', roleInput);
                    return false;
                }
                
                // 4. Check Phone Number (if provided)
                const phone = document.getElementById('phone_number');
                if (phone && phone.value.trim().length > 0) {
                    const phoneValue = phone.value.replace(/\D/g, ''); // Remove non-digits
                    if (phoneValue.length !== 10) {
                        phone.classList.add('is-invalid');
                        showValidationError('Please enter phone number in correct format (10 digits)', phone);
                        return false;
                    }
                }
                
                // 5. Check Password field
                const password = document.getElementById('password');
                if (!password || password.value.length === 0) {
                    password?.classList.add('is-invalid');
                    showValidationError('Please enter the password', password);
                    return false;
                }
                if (password.value.length < 8) {
                    password.classList.add('is-invalid');
                    showValidationError('Password must be at least 8 characters long', password);
                    return false;
                }
                
                // 6. Check if at least one permission is selected
                const permissions = document.querySelectorAll('input[name="permissions[]"]:checked');
                if (permissions.length === 0) {
                    // Highlight the permissions section
                    const permissionsSection = document.querySelector('.mb-4:has(input[name="permissions[]"])');
                    permissionsSection?.classList.add('border', 'border-danger', 'rounded', 'p-2');
                    
                    showValidationError('Please select at least one core function');
                    
                    // Remove highlight after showing error
                    setTimeout(() => {
                        permissionsSection?.classList.remove('border', 'border-danger', 'rounded', 'p-2');
                    }, 5000);
                    
                    return false;
                }
                
                return true;
            };
            
            // Helper function to validate email format
            const isValidEmail = (email) => {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            };
            
            // Add click handler to button directly - MORE RELIABLE
            if (submitButton) {
                submitButton.addEventListener('click', function(event) {
                    console.log('Button clicked, starting validation...');
                    
                    // IMMEDIATELY prevent default to stop any automatic loading states
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    // Reset button first to ensure clean state
                    resetButton();
                    
                    // Validate form
                    if (!validateForm()) {
                        console.log('Validation failed, button should be reset');
                        // Ensure button is reset after validation failure
                        setTimeout(resetButton, 10);
                        return false;
                    }
                    
                    console.log('Validation passed, setting loading state...');
                    
                    // If validation passes, show loading state and submit
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Creating Role...';
                    submitButton.disabled = true;
                    submitButton.classList.add('disabled', 'btn-loading');
                    submitButton.style.pointerEvents = 'none';
                    
                    // Submit the form programmatically
                    setTimeout(() => {
                        createRoleForm.submit();
                    }, 100);
                    
                    // Set a timeout to reset button if form submission fails
                    setTimeout(() => {
                        resetButton();
                        console.log('Timeout reached, resetting button');
                    }, 15000); // Reset after 15 seconds if no response
                });
            }
            
            // BACKUP: Also handle form submit event (in case of other submission methods)
            createRoleForm.addEventListener('submit', function(event) {
                console.log('Form submit event triggered');
                
                // If validation hasn't been done yet, do it now
                if (!this.hasAttribute('data-validated')) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    if (!validateForm()) {
                        resetButton();
                        return false;
                    }
                    
                    // Mark as validated and resubmit
                    this.setAttribute('data-validated', 'true');
                    setTimeout(() => {
                        this.submit();
                    }, 100);
                }
            });
            
            // Reset button on page load to ensure clean state
            document.addEventListener('DOMContentLoaded', function() {
                resetButton();
            });
            
            // ADDITIONAL FALLBACK: Simple click prevention method
            let isSubmitting = false;
            
            if (submitButton) {
                // Prevent multiple clicks
                submitButton.addEventListener('click', function(e) {
                    if (isSubmitting) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                });
            }
            
            // Reset isSubmitting flag when form validation fails
            const originalValidateForm = validateForm;
            validateForm = function() {
                const result = originalValidateForm();
                if (!result) {
                    isSubmitting = false; // Reset flag on validation failure
                }
                return result;
            };
            
            // ADD REAL-TIME VALIDATION CLEARING
            const formFields = [
                { id: 'Name', minLength: 2 },
                { id: 'email_id', type: 'email' },
                { id: 'role', minLength: 2 },
                { id: 'phone_number', type: 'phone' },
                { id: 'password', minLength: 8 }
            ];
            
            formFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.addEventListener('input', function() {
                        // Clear validation state when user starts typing
                        if (this.classList.contains('is-invalid')) {
                            this.classList.remove('is-invalid');
                            
                            // Clear any existing alerts
                            const existingAlert = createRoleForm.querySelector('.validation-alert');
                            if (existingAlert) {
                                existingAlert.remove();
                            }
                        }
                        
                        // Show valid state when field is properly filled
                        if (field.type === 'email' && this.value && isValidEmail(this.value)) {
                            this.classList.add('is-valid');
                        } else if (field.type === 'phone' && this.value) {
                            const phoneValue = this.value.replace(/\D/g, '');
                            if (phoneValue.length === 10) {
                                this.classList.add('is-valid');
                            } else {
                                this.classList.remove('is-valid');
                            }
                        } else if (field.minLength && this.value.trim().length >= field.minLength) {
                            this.classList.add('is-valid');
                        } else {
                            this.classList.remove('is-valid');
                        }
                    });
                    
                    // Clear validation on focus
                    element.addEventListener('focus', function() {
                        if (this.classList.contains('is-invalid')) {
                            this.classList.remove('is-invalid');
                        }
                    });
                }
            });
            
            // Clear permission validation when checkbox is checked
            const permissionCheckboxes = document.querySelectorAll('input[name="permissions[]"]');
            permissionCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedPermissions = document.querySelectorAll('input[name="permissions[]"]:checked');
                    if (checkedPermissions.length > 0) {
                        // Clear permission section highlight
                        const permissionsSection = document.querySelector('.mb-4:has(input[name="permissions[]"])');
                        permissionsSection?.classList.remove('border', 'border-danger', 'rounded', 'p-2');
                        
                        // Clear any existing alerts
                        const existingAlert = createRoleForm.querySelector('.validation-alert');
                        if (existingAlert) {
                            existingAlert.remove();
                        }
                    }
                });
            });
            
            // ADD PHONE NUMBER FORMATTING AND VALIDATION
            const phoneInput = document.getElementById('phone_number');
            if (phoneInput) {
                // Only allow numbers
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                    if (value.length > 10) value = value.substring(0, 10); // Limit to 10 digits
                    e.target.value = value;
                    
                    // Update validation state
                    if (value.length === 10) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else if (value.length > 0) {
                        this.classList.remove('is-valid');
                        if (this.classList.contains('is-invalid')) {
                            // Keep invalid state if it was already marked invalid
                        }
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                });
                
                // Prevent non-numeric input
                phoneInput.addEventListener('keydown', function(e) {
                    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                    if (allowedKeys.includes(e.key) || (e.key >= '0' && e.key <= '9')) {
                        return true;
                    }
                    e.preventDefault();
                    return false;
                });
            }
        }
        
        // EMERGENCY RESET FUNCTION - Can be called from browser console if needed
        window.resetCreateRoleButton = function() {
            const btn = document.getElementById('submitButton');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-save me-2"></i> Create Role';
                btn.disabled = false;
                btn.classList.remove('disabled', 'btn-loading');
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                btn.removeAttribute('disabled');
                
                // Also clear all validation states
                const invalidFields = document.querySelectorAll('.is-invalid');
                invalidFields.forEach(field => field.classList.remove('is-invalid'));
                
                const validFields = document.querySelectorAll('.is-valid');
                validFields.forEach(field => field.classList.remove('is-valid'));
                
                // Clear alerts
                const existingAlert = document.querySelector('.validation-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                console.log('Emergency button and form reset completed');
            }
        };
        
        // SIMPLE ALTERNATIVE VALIDATION FUNCTION (backup)
        window.simpleValidation = function() {
            const requiredFields = [
                { id: 'Name', message: 'Required name field' },
                { id: 'email_id', message: 'Required email id' },
                { id: 'role', message: 'Required role title' },
                { id: 'password', message: 'Please enter the password' }
            ];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || element.value.trim().length === 0) {
                    alert(field.message);
                    element?.focus();
                    return false;
                }
            }
            
            const permissions = document.querySelectorAll('input[name="permissions[]"]:checked');
            if (permissions.length === 0) {
                alert('Please select at least one core function');
                return false;
            }
            
            return true;
        };
    });
</script>

<style>
    /* Enhanced Mobile-Friendly Styles */
    .avatar-circle {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: 600;
    }
    
    .permission-chips {
        display: flex;
        flex-wrap: nowrap;
        overflow: hidden;
    }
    
    .permission-chips-container {
        display: flex;
        flex-wrap: wrap;
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
    }
    
    .permission-chips-container .badge {
        margin-right: 4px;
        margin-bottom: 4px;
        white-space: normal;
        text-align: left;
        padding: 5px 8px;
        line-height: 1.2;
        font-size: 0.75rem;
    }
    
    /* Button loading states - ENHANCED */
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .btn .fa-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Validation alert styles - NEW */
    .validation-alert {
        margin-bottom: 1rem;
        border-left: 4px solid #dc3545;
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .validation-alert .btn-close {
        padding: 0.5rem;
    }
    
    /* Form improvements */
    .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
        border-color: #86b7fe;
    }
    
    .form-control:invalid {
        border-color: #dc3545;
    }
    
    .form-control:invalid:focus {
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .card {
            border-radius: 0.75rem;
        }
        
        .role-card-mobile {
            transition: background-color 0.2s ease;
        }
        
        .role-card-mobile:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .btn-group .btn {
            padding: 0.375rem 0.5rem;
        }
        
        .dropdown-menu {
            min-width: 150px;
        }
        
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .permission-chips-container .badge {
            font-size: 0.7rem;
        }
        
        .validation-alert {
            font-size: 0.9rem;
        }
    }
    
    /* Touch-friendly buttons */
    .btn-sm {
        min-height: 38px;
        min-width: 38px;
    }
    
    /* Better hover states */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    /* Sticky table header improvements */
    .sticky-top {
        z-index: 1020;
    }
    
    /* Better spacing for mobile */
    @media (max-width: 576px) {
        .g-4 {
            --bs-gutter-x: 1rem;
            --bs-gutter-y: 1rem;
        }
        
        .py-3 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }
        
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        
        .card-body .row .col-12 {
            margin-bottom: 1rem;
        }
        
        .form-check-label {
            font-size: 0.9rem;
        }
        
        .card-title {
            font-size: 1rem;
        }
        
        .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
    }
    
    /* Accessibility improvements */
    .btn:focus {
        outline: 2px solid #0d6efd;
        outline-offset: 2px;
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Loading state improvements - ENHANCED */
    .btn.disabled, .btn.btn-loading {
        position: relative;
        overflow: hidden;
        pointer-events: none !important;
        cursor: not-allowed !important;
    }
    
    .btn.disabled::after, .btn.btn-loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        pointer-events: none;
    }
    
    /* Force button reset styles */
    .btn:not(.disabled):not(.btn-loading) {
        pointer-events: auto !important;
        cursor: pointer !important;
        opacity: 1 !important;
    }
    
    /* Additional validation improvements */
    .permission-section-invalid {
        border: 2px solid #dc3545 !important;
        border-radius: 0.375rem !important;
        padding: 1rem !important;
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    /* Better feedback for valid fields */
    .form-control.is-valid {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.94-.94 1.36 1.36L8.23 3.52 7.3 2.58 4.25 5.63l-.94-.94z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        padding-right: calc(1.5em + 0.75rem);
    }
    
    .form-control.is-invalid {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.5 5.5 1 1 1-1'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        padding-right: calc(1.5em + 0.75rem);
    }
    
    /* Phone number specific styling */
    #phone_number {
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
    }
    
    /* Form focus improvements */
    .form-control:focus {
        transform: translateY(-1px);
        transition: all 0.2s ease;
    }
    
    /* Clean initial state */
    .form-control:not(.is-invalid):not(.is-valid) {
        background-image: none !important;
    }
</style>
{% endblock %}