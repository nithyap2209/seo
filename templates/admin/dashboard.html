
{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="row dashboard-stats-row">
    <!-- Summary Cards -->
    <div class="col-xl-3 col-md-6 col-sm-6 mb-4">
        <div class="stat-card">
            <div class="stat-card-body">
                <div class="icon icon-users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Total Users</div>
                    <div class="stat-value">{{ total_users|default(0) }}</div>
                    <div class="stat-desc">{{ active_users|default(0) }} active, {{ unconfirmed_users|default(0) }} unconfirmed</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 col-sm-6 mb-4">
        <div class="stat-card">
            <div class="stat-card-body">
                <div class="icon icon-subscriptions">
                    <i class="fas fa-tag"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Subscriptions</div>
                    <div class="stat-value">{{ active_subscriptions|default(0) }}</div>
                    <div class="stat-desc">{{ expired_subscriptions|default(0) }} expired</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 col-sm-6 mb-4">
        <div class="stat-card">
            <div class="stat-card-body">
                <div class="icon icon-revenue">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Monthly Revenue</div>
                    <div class="stat-value">₹{{ "{:,.2f}".format(monthly_revenue|default(0)) }}</div>
                    <div class="stat-desc">Total: ₹{{ "{:,.2f}".format(total_revenue|default(0)) }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 col-sm-6 mb-4">
        <div class="stat-card">
            <div class="stat-card-body">
                <div class="icon icon-expiring">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Expiring Soon</div>
                    <div class="stat-value">{{ expiring_soon|length }}</div>
                    <div class="stat-desc">Subscriptions in next 7 days</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Auto-Renewal Statistics -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card chart-card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0">Auto-Renewal Status</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3 flex-grow-1 position-relative" style="min-height: 200px;">
                    <canvas id="renewalChart" style="max-height: 200px;"></canvas>
                </div>
                <div class="mt-auto">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="mb-1 text-primary">{{ auto_renewal_count|default(0) }}</h4>
                            <small class="text-muted">Auto-Renewal</small>
                        </div>
                        <div class="col-6">
                            <h4 class="mb-1 text-danger">{{ non_renewal_count|default(0) }}</h4>
                            <small class="text-muted">Manual Renewal</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Types Distribution -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card chart-card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0">Payment Methods</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3 flex-grow-1 position-relative" style="min-height: 200px;">
                    <canvas id="paymentTypeChart" style="max-height: 200px;"></canvas>
                </div>
                <div class="mt-auto">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Payment Type</th>
                                    <th class="text-end">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment_type in payment_types %}
                                <tr>
                                    <td>{{ payment_type.payment_type|default('N/A')|title }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary rounded-pill">{{ payment_type.count|default(0) }}</span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">No payment data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Subscription Actions -->
    <div class="col-xl-4 col-lg-12 mb-4">
        <div class="card chart-card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0">Subscription Activities (30 days)</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3 flex-grow-1 position-relative" style="min-height: 200px;">
                    <canvas id="subscriptionActionsChart" style="max-height: 200px;"></canvas>
                </div>
                <div class="mt-auto">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th class="text-end">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for action in subscription_actions %}
                                <tr>
                                    <td>
                                        <span class="fw-medium">{{ action.action|title }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-success rounded-pill">{{ action.count|default(0) }}</span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted">No activity data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


    
<div class="row">
    <!-- Popular Plans -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card chart-card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0">Popular Subscription Plans</h5>
                <a href="{{ url_for('admin_subscriptions') }}" class="btn btn-sm btn-primary">Manage Plans</a>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3 flex-grow-1 position-relative" style="min-height: 200px;">
                    <canvas id="plansChart" style="max-height: 200px;"></canvas>
                </div>
                <div class="mt-auto">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Plan</th>
                                    <th class="text-center">Subscribers</th>
                                    <th class="text-end">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_subscribers = popular_plans|sum(attribute='subscribers') %}
                                {% for plan in popular_plans %}
                                <tr>
                                    <td><span class="fw-medium">{{ plan.plan }}</span></td>
                                    <td class="text-center"><span class="badge bg-info rounded-pill">{{ plan.subscribers }}</span></td>
                                    <td class="text-end">
                                        <span class="text-muted">
                                            {% if total_subscribers > 0 %}
                                                {{ "{:.1f}%".format((plan.subscribers / total_subscribers) * 100) }}
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No subscription data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Stats -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card chart-card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0">Token Usage Overview</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3 flex-grow-1 position-relative" style="min-height: 200px;">
                    <canvas id="tokenChart" style="max-height: 200px;"></canvas>
                </div>
                <div class="mt-auto text-center">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="mb-1 text-success">{{ token_chart_data.tokens_purchased }}</h6>
                            <small class="text-muted">Tokens Purchased</small>
                        </div>
                        <div class="col-6">
                            <h6 class="mb-1 text-primary">₹{{ "{:,.2f}".format(token_chart_data.total_amount) }}</h6>
                            <small class="text-muted">Total Revenue</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Payments -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <h5 class="mb-0">Recent Payments</h5>
                <a href="{{ url_for('admin_payments') }}" class="btn btn-sm btn-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <!-- Desktop Table View -->
                <div class="desktop-table-view">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Plan</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in recent_payments %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('admin_user_details', user_id=item.user.id) }}">{{ item.user.name }}</a>
                                    </td>
                                    <td>{{ item.subscription.plan }}</td>
                                    <td>₹{{ item.format_amount() }}</td>
                                    <td>{{ item.payment.created_at.strftime('%d %b, %Y') }}</td>
                                    <td>
                                        {% if item.payment.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif item.payment.status == 'failed' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% elif item.payment.status == 'created' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ item.payment.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No recent payments</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mobile Card View -->
                <div class="mobile-card-view">
                    {% for item in recent_payments %}
                    <div class="mobile-data-card">
                        <div class="card-header-mobile">
                            <div class="d-flex align-items-center flex-grow-1">
                                <div class="avatar-circle bg-primary-subtle text-primary me-2">
                                    {{ item.user.name[:1]|upper }}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">{{ item.user.name }}</div>
                                    <div class="small text-muted">{{ item.subscription.plan }}</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">₹{{ item.format_amount() }}</div>
                                {% if item.payment.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                {% elif item.payment.status == 'failed' %}
                                    <span class="badge bg-danger">Failed</span>
                                {% elif item.payment.status == 'created' %}
                                    <span class="badge bg-warning">Pending</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ item.payment.status }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body-mobile">
                            <div class="data-label">Date:</div>
                            <div class="data-value">{{ item.payment.created_at.strftime('%d %b, %Y') }}</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No recent payments</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
      
   

    <!-- Pagination Controls -->
<nav aria-label="Recent payments pagination" class="mt-3">
  <ul class="pagination justify-content-center">
    {% if recent_payments_pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('admin_dashboard', page=recent_payments_pagination.prev_num) }}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Previous</span>
      </li>
    {% endif %}

    {% for page_num in recent_payments_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if page_num == recent_payments_pagination.page %}
          <li class="page-item active">
            <span class="page-link">{{ page_num }}</span>
          </li>
        {% else %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_dashboard', page=page_num) }}">{{ page_num }}</a>
          </li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
    {% endfor %}

    {% if recent_payments_pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('admin_dashboard', page=recent_payments_pagination.next_num) }}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next</span>
      </li>
    {% endif %}
  </ul>
</nav>
</div>
</div>
<div class="row">
    <!-- Subscriptions Expiring Soon -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                <h5 class="mb-0">Subscriptions Expiring in Next 7 Days</h5>
                <a href="{{ url_for('admin_subscribed_users') }}" class="btn btn-sm btn-primary">View All Subscriptions</a>
            </div>
            <div class="card-body p-0">
                <!-- Desktop Table View -->
                <div class="desktop-table-view">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Plan</th>
                                    <th>Expiry Date</th>
                                    <th>Days Left</th>
                                    <th>Auto-Renewal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user, subscription, subscribed_user in expiring_soon %}
                                {% set modal_id = 'extendModal' ~ subscribed_user.id %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('admin_user_details', user_id=user.id) }}">{{ user.name }}</a>
                                    </td>
                                    <td>{{ user.company_email }}</td>
                                    <td>{{ subscription.plan }}</td>
                                    <td>{{ subscribed_user.end_date.strftime('%d %b, %Y') }}</td>
                                    <td>
                                        {% set days_left = (subscribed_user.end_date - now).days %}
                                        {% if days_left <= 2 %}
                                            <span class="badge bg-danger">{{ days_left }} days</span>
                                        {% elif days_left <= 5 %}
                                            <span class="badge bg-warning">{{ days_left }} days</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ days_left }} days</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if subscribed_user.is_auto_renew %}
                                            <span class="badge bg-success">Enabled</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Disabled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('admin_edit_subscribed_user', id=subscribed_user.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#{{ modal_id }}">
                                                <i class="fas fa-clock"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No subscriptions expiring in the next 7 days</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mobile Card View -->
                <div class="mobile-card-view">
                    {% for user, subscription, subscribed_user in expiring_soon %}
                    {% set modal_id = 'extendModal' ~ subscribed_user.id %}
                    <div class="mobile-data-card">
                        <div class="card-header-mobile">
                            <div class="d-flex align-items-center flex-grow-1">
                                <div class="avatar-circle bg-primary-subtle text-primary me-2">
                                    {{ user.name[:1]|upper }}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">{{ user.name }}</div>
                                    <div class="small text-muted">{{ user.company_email }}</div>
                                </div>
                            </div>
                            <div class="text-end">
                                {% set days_left = (subscribed_user.end_date - now).days %}
                                {% if days_left <= 2 %}
                                    <span class="badge bg-danger">{{ days_left }} days</span>
                                {% elif days_left <= 5 %}
                                    <span class="badge bg-warning">{{ days_left }} days</span>
                                {% else %}
                                    <span class="badge bg-info">{{ days_left }} days</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="card-body-mobile">
                            <div class="data-label">Plan:</div>
                            <div class="data-value">{{ subscription.plan }}</div>
                            
                            <div class="data-label">Expires:</div>
                            <div class="data-value">{{ subscribed_user.end_date.strftime('%d %b, %Y') }}</div>
                            
                            <div class="data-label">Auto-Renewal:</div>
                            <div class="data-value">
                                {% if subscribed_user.is_auto_renew %}
                                    <span class="badge bg-success">Enabled</span>
                                {% else %}
                                    <span class="badge bg-secondary">Disabled</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="card-actions-mobile">
                            <a href="{{ url_for('admin_edit_subscribed_user', id=subscribed_user.id) }}" class="btn btn-sm btn-outline-primary flex-fill">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-success flex-fill" data-bs-toggle="modal" data-bs-target="#{{ modal_id }}">
                                <i class="fas fa-clock"></i> Extend
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No subscriptions expiring in the next 7 days</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extend Subscription Modals -->
{% for user, subscription, subscribed_user in expiring_soon %}
{% set modal_id = 'extendModal' ~ subscribed_user.id %}
<div class="modal fade" id="{{ modal_id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Extend Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin_extend_subscription', id=subscribed_user.id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <div class="modal-body">
                    <p>Extend subscription for <strong>{{ user.name }}</strong> ({{ subscription.plan }} plan)</p>
                    <div class="mb-3">
                        <label for="extension_days_{{ subscribed_user.id }}" class="form-label">Days to extend</label>
                        <input type="number" class="form-control" id="extension_days_{{ subscribed_user.id }}" name="extension_days" min="1" max="365" value="30" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="notify_user" id="notify_user_{{ subscribed_user.id }}" checked>
                        <label class="form-check-label" for="notify_user_{{ subscribed_user.id }}">
                            Notify user about extension
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Extend Subscription</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Debug Information (Remove in production) -->
<div style="display: none;" id="debug-info">
    <p>Plans Data: {{ popular_plans|tojson }}</p>
    <p>Payment Types: {{ payment_types|tojson }}</p>
    <p>Subscription Actions: {{ subscription_actions|tojson }}</p>
    <p>Auto Renewal: {{ auto_renewal_count }}, Manual: {{ non_renewal_count }}</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Wait for DOM and Chart.js to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Add a small delay to ensure Chart.js is fully loaded
    setTimeout(function() {
        initializeCharts();
        initializeTokenChart();

    }, 100);
});

function initializeCharts() {
    console.log('Starting chart initialization...');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded. Please check if the library is included.');
        return;
    }

    // Set default Chart.js configuration
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    Chart.defaults.plugins.legend.position = 'bottom';

    // Initialize all charts
    initializeRenewalChart();
    initializePlansChart();
    initializePaymentTypeChart();
    initializeActionsChart();
}
function initializeTokenChart() {
    const ctx = document.getElementById('tokenChart');
    if (!ctx) {
        console.error('Token chart canvas not found');
        return;
    }

    const data = {
        labels: ['Tokens Purchased', 'Revenue'],
        datasets: [{
            label: 'Tokens & Revenue',
            data: [{{ token_chart_data.tokens_purchased or 0 }}, {{ token_chart_data.total_amount or 0 }}],
            backgroundColor: [
                'rgba(76, 201, 164, 0.8)',
                'rgba(67, 97, 238, 0.8)'
            ],
            borderColor: [
                'rgba(76, 201, 164, 1)',
                'rgba(67, 97, 238, 1)'
            ],
            borderWidth: 2
        }]
    };

    new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}


function initializeRenewalChart() {
    const ctx = document.getElementById('renewalChart');
    if (!ctx) {
        console.error('Renewal chart canvas not found');
        return;
    }

    const autoCount = {{ auto_renewal_count|default(0) }};
    const manualCount = {{ non_renewal_count|default(0) }};
    
    console.log('Renewal data:', { autoCount, manualCount });

    if (autoCount === 0 && manualCount === 0) {
        ctx.getContext('2d').fillText('No renewal data available', 50, 100);
        return;
    }

    try {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Auto-Renewal', 'Manual Renewal'],
                datasets: [{
                    data: [autoCount, manualCount],
                    backgroundColor: [
                        'rgba(67, 97, 238, 0.8)',
                        'rgba(239, 71, 111, 0.8)'
                    ],
                    borderColor: [
                        'rgba(67, 97, 238, 1)',
                        'rgba(239, 71, 111, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: window.innerWidth <= 768 ? 10 : 12
                            }
                        }
                    }
                }
            }
        });
        console.log('Renewal chart created successfully');
    } catch (error) {
        console.error('Error creating renewal chart:', error);
    }
}

function initializePlansChart() {
    const ctx = document.getElementById('plansChart');
    if (!ctx) {
        console.error('Plans chart canvas not found');
        return;
    }

    const plansData = {{ popular_plans|tojson|safe }};
    console.log('Plans data:', plansData);

    if (!plansData || plansData.length === 0) {
        ctx.getContext('2d').fillText('No subscription plans data available', 50, 100);
        return;
    }

    const labels = plansData.map(item => item.plan);
    const data = plansData.map(item => item.subscribers || 0);
    
    if (data.every(val => val === 0)) {
        ctx.getContext('2d').fillText('No active subscriptions', 50, 100);
        return;
    }

    const backgroundColors = [
        'rgba(67, 97, 238, 0.8)',
        'rgba(76, 201, 164, 0.8)',
        'rgba(249, 199, 79, 0.8)',
        'rgba(239, 71, 111, 0.8)',
        'rgba(72, 149, 239, 0.8)'
    ];

    try {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, data.length),
                    borderColor: backgroundColors.slice(0, data.length).map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: window.innerWidth <= 768 ? 10 : 12
                            }
                        }
                    }
                }
            }
        });
        console.log('Plans chart created successfully');
    } catch (error) {
        console.error('Error creating plans chart:', error);
    }
}

function initializePaymentTypeChart() {
    const ctx = document.getElementById('paymentTypeChart');
    if (!ctx) {
        console.error('Payment type chart canvas not found');
        return;
    }

    const paymentData = {{ payment_types|tojson|safe }};
    console.log('Payment types data:', paymentData);

    if (!paymentData || paymentData.length === 0) {
        ctx.getContext('2d').fillText('No payment data available', 50, 100);
        return;
    }

    const labels = paymentData.map(item => item.payment_type || 'Unknown');
    const data = paymentData.map(item => item.count || 0);

    if (data.every(val => val === 0)) {
        ctx.getContext('2d').fillText('No payment history', 50, 100);
        return;
    }

    const backgroundColors = [
        'rgba(76, 201, 164, 0.8)',
        'rgba(249, 199, 79, 0.8)',
        'rgba(239, 71, 111, 0.8)',
        'rgba(67, 97, 238, 0.8)',
        'rgba(72, 149, 239, 0.8)'
    ];

    try {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, data.length),
                    borderColor: backgroundColors.slice(0, data.length).map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: window.innerWidth <= 768 ? 10 : 12
                            }
                        }
                    }
                }
            }
        });
        console.log('Payment type chart created successfully');
    } catch (error) {
        console.error('Error creating payment type chart:', error);
    }
}

function initializeActionsChart() {
    const ctx = document.getElementById('subscriptionActionsChart');
    if (!ctx) {
        console.error('Actions chart canvas not found');
        return;
    }

    const actionsData = {{ subscription_actions|tojson|safe }};
    console.log('Actions data:', actionsData);

    if (!actionsData || actionsData.length === 0) {
        ctx.getContext('2d').fillText('No subscription activity data', 50, 100);
        return;
    }

    const labels = actionsData.map(item => item.action || 'Unknown');
    const data = actionsData.map(item => item.count || 0);

    if (data.every(val => val === 0)) {
        ctx.getContext('2d').fillText('No recent subscription activities', 50, 100);
        return;
    }

    const backgroundColors = [
        'rgba(67, 97, 238, 0.8)',
        'rgba(76, 201, 164, 0.8)',
        'rgba(249, 199, 79, 0.8)',
        'rgba(239, 71, 111, 0.8)',
        'rgba(72, 149, 239, 0.8)'
    ];

    try {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Actions',
                    data: data,
                    backgroundColor: backgroundColors.slice(0, data.length),
                    borderColor: backgroundColors.slice(0, data.length).map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            font: {
                                size: window.innerWidth <= 768 ? 10 : 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: window.innerWidth <= 768 ? 10 : 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        console.log('Actions chart created successfully');
    } catch (error) {
        console.error('Error creating actions chart:', error);
    }
}

// Mobile responsiveness
window.addEventListener('resize', function() {
    // Redraw charts on window resize for better mobile experience
    Chart.helpers.each(Chart.instances, function(instance) {
        instance.resize();
    });
});
</script>

<style>
/* Mobile-specific chart improvements */
@media (max-width: 768px) {
    .chart-card {
        height: auto !important;
        min-height: 300px;
    }
    
    .chart-card .card-body {
        padding: 1rem;
    }
    
    .chart-card canvas {
        max-height: 180px !important;
    }
    
    .stat-card .stat-value {
        font-size: 1.25rem;
    }
    
    .stat-card .stat-desc {
        font-size: 0.7rem;
        line-height: 1.2;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .modal-dialog {
        margin: 1rem;
    }
    
    .btn-group {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
}

@media (max-width: 576px) {
    .chart-card {
        min-height: 250px;
    }
    
    .chart-card canvas {
        max-height: 150px !important;
    }
    
    .stat-card .stat-card-body {
        padding: 0.75rem;
    }
    
    .stat-card .icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
        margin-right: 0.75rem;
    }
    
    .table-responsive table {
        font-size: 0.8rem;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}