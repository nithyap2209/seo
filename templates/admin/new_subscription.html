{% extends "admin/base.html" %}

{% block title %}Add New Subscription Plan{% endblock %}

{% block page_title %}
<div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
    <h1 class="h3 mb-2 mb-sm-0">Add New Subscription Plan</h1>
    <a href="{{ url_for('admin_subscriptions') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>
        <span class="d-none d-sm-inline">Back to Plans</span>
        <span class="d-sm-none">Back</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-8">
        <!-- Main Form Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Create New Plan</h5>
            </div>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show mx-3 mt-3" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
            {% endwith %}
            
            <div class="card-body">
                <form action="{{ url_for('admin_new_subscription') }}" method="POST" id="newSubscriptionForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    
                    <div class="row g-3">
                        <!-- Plan Name -->
                        <div class="col-md-6">
                            <label for="plan" class="form-label">Plan Name *</label>
                            <input type="text" class="form-control" id="plan" name="plan" 
                                   placeholder="e.g., Basic Plan, Premium Plan" required>
                            <div class="form-text">Choose a descriptive name for your plan</div>
                        </div>
                        
                        <!-- Price -->
                        <div class="col-md-6">
                            <label for="price" class="form-label">Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="price" name="price" 
                                       step="0.01" min="0" placeholder="199.00" required>
                            </div>
                            <div class="form-text">Set the cost for this subscription</div>
                        </div>
                        
                        <!-- Duration with Quick Options -->
                        <div class="col-md-6">
                            <label for="days" class="form-label">Duration (days) *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="days" name="days" min="1" 
                                       placeholder="30" required>
                                <span class="input-group-text">days</span>
                            </div>
                            <div class="form-text">How long will this subscription last?</div>
                            <div class="mt-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-days="7">1 Week</button>
                                    <button type="button" class="btn btn-outline-secondary" data-days="30">1 Month</button>
                                    <button type="button" class="btn btn-outline-secondary" data-days="90">3 Months</button>
                                    <button type="button" class="btn btn-outline-secondary" data-days="365">1 Year</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Daily Usage with Quick Options -->
                        <div class="col-md-6">
                            <label for="usage_per_day" class="form-label">Daily Usage Limit *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="usage_per_day" name="usage_per_day" 
                                       min="1" placeholder="100" required>
                                <span class="input-group-text">requests</span>
                            </div>
                            <div class="form-text">Maximum API requests per day</div>
                            <div class="mt-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-usage="50">50</button>
                                    <button type="button" class="btn btn-outline-secondary" data-usage="100">100</button>
                                    <button type="button" class="btn btn-outline-secondary" data-usage="500">500</button>
                                    <button type="button" class="btn btn-outline-secondary" data-usage="1000">1000</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tier -->
                        <div class="col-md-6">
                            <label for="tier" class="form-label">Tier Level *</label>
                            <input type="number" class="form-control" id="tier" name="tier" min="1" 
                                   placeholder="1" value="1" required>
                            <div class="form-text">Priority level (1 = lowest priority)</div>
                        </div>
                        
                        <!-- Status -->
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="is_active" 
                                       name="is_active" checked>
                                <label class="form-check-label" for="is_active">
                                    Active Plan
                                </label>
                            </div>
                            <div class="form-text">Active plans are available for users</div>
                        </div>
                        
                        <!-- Features -->
                        <div class="col-12">
                            <label for="features" class="form-label">Features (JSON)</label>
                            <textarea class="form-control" id="features" name="features" rows="3" 
                                      placeholder='{"premium_support": true, "analytics": false}'></textarea>
                            <div class="form-text">Optional: Enter features in JSON format</div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex flex-column flex-sm-row gap-2 mt-4">
                        <a href="{{ url_for('admin_subscriptions') }}" class="btn btn-outline-secondary order-2 order-sm-1">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary order-1 order-sm-2">
                            Create Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Live Preview</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h4 class="text-primary" id="preview-plan-name">New Subscription Plan</h4>
                </div>
                
                <div class="row g-3 text-center">
                    <div class="col-6 col-lg-3">
                        <div class="p-3 bg-light rounded">
                            <div class="h5 mb-1" id="preview-price">₹0</div>
                            <small class="text-muted">Price</small>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="p-3 bg-light rounded">
                            <div class="h5 mb-1" id="preview-days">0 days</div>
                            <small class="text-muted">Duration</small>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="p-3 bg-light rounded">
                            <div class="h5 mb-1" id="preview-usage">0/day</div>
                            <small class="text-muted">Usage</small>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="p-3 bg-light rounded">
                            <div class="h5 mb-1" id="preview-tier">Tier 1</div>
                            <small class="text-muted">Level</small>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <span class="badge bg-success" id="preview-status">Active Plan</span>
                </div>
            </div>
        </div>

        <!-- Tips Card -->
        <div class="card mt-4 border-info">
            <div class="card-header bg-info bg-opacity-10">
                <h5 class="mb-0 text-info">💡 Tips for Creating Plans</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6 class="text-success">Pricing Strategy</h6>
                        <p class="mb-0 small text-muted">
                            Consider offering different tiers with varying features and usage limits to cater to different user needs.
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">User Experience</h6>
                        <p class="mb-0 small text-muted">
                            Use clear, descriptive plan names and set reasonable usage limits that align with typical user behavior.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Form Enhancements */
.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    font-weight: 500;
}

/* Quick option buttons */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.btn-group .btn.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

/* Preview Cards */
.bg-light {
    background-color: #f8f9fa !important;
}

/* Form Validation */
.is-invalid {
    border-color: #dc3545;
}

.is-valid {
    border-color: #198754;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

/* Mobile Optimizations */
@media (max-width: 768px) {
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .btn-group {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin: 0 !important;
        flex: 1;
        min-width: 60px;
    }
    
    .form-control, .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
    }
}

/* Loading State */
.btn.loading {
    pointer-events: none;
    opacity: 0.65;
}

.btn.loading::after {
    content: "";
    display: inline-block;
    width: 1rem;
    height: 1rem;
    margin-left: 0.5rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Preview pulse animation */
.preview-pulse {
    animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('newSubscriptionForm');
    const featuresInput = document.getElementById('features');
    
    // Form inputs for preview updates
    const planInput = document.getElementById('plan');
    const priceInput = document.getElementById('price');
    const daysInput = document.getElementById('days');
    const usageInput = document.getElementById('usage_per_day');
    const tierInput = document.getElementById('tier');
    const activeInput = document.getElementById('is_active');
    
    // Preview elements
    const previewPlanName = document.getElementById('preview-plan-name');
    const previewPrice = document.getElementById('preview-price');
    const previewDays = document.getElementById('preview-days');
    const previewUsage = document.getElementById('preview-usage');
    const previewTier = document.getElementById('preview-tier');
    const previewStatus = document.getElementById('preview-status');

    // Update preview in real-time
    function updatePreview() {
        // Add pulse animation
        const previewCard = previewPlanName.closest('.card');
        previewCard.classList.add('preview-pulse');
        setTimeout(() => previewCard.classList.remove('preview-pulse'), 500);

        if (planInput && previewPlanName) {
            previewPlanName.textContent = planInput.value || 'New Subscription Plan';
        }
        if (priceInput && previewPrice) {
            previewPrice.textContent = `₹${priceInput.value || '0'}`;
        }
        if (daysInput && previewDays) {
            previewDays.textContent = `${daysInput.value || '0'} days`;
        }
        if (usageInput && previewUsage) {
            previewUsage.textContent = `${usageInput.value || '0'}/day`;
        }
        if (tierInput && previewTier) {
            previewTier.textContent = `Tier ${tierInput.value || '1'}`;
        }
        if (activeInput && previewStatus) {
            if (activeInput.checked) {
                previewStatus.className = 'badge bg-success';
                previewStatus.textContent = 'Active Plan';
            } else {
                previewStatus.className = 'badge bg-secondary';
                previewStatus.textContent = 'Inactive Plan';
            }
        }
    }

    // Add event listeners for real-time preview updates
    [planInput, priceInput, daysInput, usageInput, tierInput].forEach(input => {
        if (input) {
            input.addEventListener('input', updatePreview);
        }
    });

    if (activeInput) {
        activeInput.addEventListener('change', updatePreview);
    }

    // Quick option buttons for days
    document.querySelectorAll('[data-days]').forEach(btn => {
        btn.addEventListener('click', function() {
            const days = this.getAttribute('data-days');
            daysInput.value = days;
            updatePreview();
            
            // Update button states
            document.querySelectorAll('[data-days]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Validate the field
            daysInput.classList.remove('is-invalid');
            daysInput.classList.add('is-valid');
        });
    });

    // Quick option buttons for usage
    document.querySelectorAll('[data-usage]').forEach(btn => {
        btn.addEventListener('click', function() {
            const usage = this.getAttribute('data-usage');
            usageInput.value = usage;
            updatePreview();
            
            // Update button states
            document.querySelectorAll('[data-usage]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Validate the field
            usageInput.classList.remove('is-invalid');
            usageInput.classList.add('is-valid');
        });
    });

    // JSON validation for features field
    function validateJSON() {
        const value = featuresInput.value.trim();
        if (!value) {
            featuresInput.classList.remove('is-invalid', 'is-valid');
            return true;
        }

        try {
            JSON.parse(value);
            featuresInput.classList.remove('is-invalid');
            featuresInput.classList.add('is-valid');
            return true;
        } catch (e) {
            featuresInput.classList.remove('is-valid');
            featuresInput.classList.add('is-invalid');
            
            // Add error message
            let feedback = featuresInput.parentNode.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                featuresInput.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Please enter valid JSON format';
            return false;
        }
    }

    // JSON validation events
    if (featuresInput) {
        featuresInput.addEventListener('blur', validateJSON);
    }

    // Form validation on submit
    if (form) {
        form.addEventListener('submit', function(event) {
            let isValid = true;

            // Validate required fields
            const requiredFields = ['plan', 'price', 'days', 'usage_per_day', 'tier'];
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field && !field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else if (field) {
                    field.classList.remove('is-invalid');
                    field.classList.add('is-valid');
                }
            });

            // Validate JSON if provided
            if (featuresInput && featuresInput.value.trim()) {
                if (!validateJSON()) {
                    isValid = false;
                }
            }

            // Validate positive numbers
            const numberFields = ['price', 'days', 'usage_per_day', 'tier'];
            numberFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field && (parseFloat(field.value) <= 0 || isNaN(parseFloat(field.value)))) {
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });

            if (!isValid) {
                event.preventDefault();
                
                // Scroll to first invalid field
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
                return false;
            }

            // Add loading state to submit button
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            }
        });
    }

    // Real-time validation for number inputs
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        input.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value <= 0 || isNaN(value)) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });

    // Real-time validation for text inputs
    if (planInput) {
        planInput.addEventListener('input', function() {
            if (this.value.trim().length < 3) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    }

    // Auto-format JSON on blur
    if (featuresInput) {
        featuresInput.addEventListener('blur', function() {
            const value = this.value.trim();
            if (value) {
                try {
                    const parsed = JSON.parse(value);
                    this.value = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    // Don't auto-format if JSON is invalid
                }
            }
        });
    }

    // Initialize preview
    updatePreview();
});
</script>
{% endblock %}